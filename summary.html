<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lock In â€” Summary</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: #07102a;
      --accent: #60a5fa;
      --muted: #9fb7cf;
      --text: #eaf6ff;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    body{ margin:0; padding:18px; background: linear-gradient(180deg,#041022,#081427); color:var(--text); }
    .wrap{ max-width:920px; margin:0 auto; }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow: 0 8px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03); }
    h1{ margin:0 0 6px 0; font-size:20px; }
    .meta{ color:var(--muted); margin-bottom:12px; }
    .controls{ display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap; }
    button{ background:var(--accent); color:#032; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.secondary{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text); }
    #chartWrap{ height:220px; margin:12px 0; display:flex; align-items:center; }
    canvas{ width:100%; height:220px; background:var(--glass); border-radius:8px; display:block; }
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th, td{ text-align:left; padding:8px 10px; border-bottom:1px dashed rgba(255,255,255,0.03); }
    th{ color:var(--muted); font-size:13px; }
    td.count{ width:90px; text-align:right; font-weight:700; color:var(--accent); }
    .empty{ color:var(--muted); padding:18px; text-align:center; }
    .footer{ margin-top:12px; color:var(--muted); font-size:13px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .history{ margin-top:24px; }
    .history h2{ font-size:18px; margin-bottom:12px; }
    .history .session{ margin-bottom:12px; padding:12px; background:var(--glass); border-radius:8px; }
    .history .session h3{ font-size:16px; margin:0 0 6px 0; }
    .history .session p{ margin:0; color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Session attempts summary</h1>
      <div class="meta" id="metaText">Loading...</div>

      <div class="controls">
        <button id="exportCsv">Export CSV</button>
        <button id="clearCounts" class="secondary">Clear counters</button>
        <button id="closeTab" class="secondary">Close</button>
      </div>

      <div id="chartWrap"><canvas id="barChart"></canvas></div>

      <div id="tableWrap"></div>

      <div class="footer">
        <div id="totalText"></div>
        <div id="lastUpdated" class="muted"></div>
      </div>
    </div>

    <div class="card history">
      <h2>Session History</h2>
      <div id="historyWrap">Loading...</div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'attemptCounters';
    const HISTORY_KEY = 'sessionHistory';

    async function loadCounters() {
      return new Promise(resolve => {
        chrome.storage.local.get([STORAGE_KEY], (res) => {
          resolve(res[STORAGE_KEY] || {});
        });
      });
    }

    async function loadHistory() {
      return new Promise(resolve => {
        chrome.storage.local.get([HISTORY_KEY], (res) => {
          resolve(res[HISTORY_KEY] || []);
        });
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderTable(entries) {
      const wrap = document.getElementById('tableWrap');
      if (!entries.length) {
        wrap.innerHTML = '<div class="empty">No attempts recorded during the last focus session.</div>';
        return;
      }
      let html = '<table><thead><tr><th>Site</th><th style="text-align:right">Attempts</th></tr></thead><tbody>';
      for (const [site, count] of entries) {
        html += `<tr><td>${escapeHtml(site)}</td><td class="count">${count}</td></tr>`;
      }
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    function renderHistory(history) {
      const wrap = document.getElementById('historyWrap');
      if (!history.length) {
        wrap.innerHTML = '<div class="empty">No session history available.</div>';
        return;
      }
      wrap.innerHTML = history.map(session => `
        <div class="session">
          <h3>${new Date(session.date).toLocaleString()}</h3>
          <p>Duration: ${session.duration} minutes</p>
          <p>Attempts: ${Object.entries(session.counters).map(([site, count]) => `${site}: ${count}`).join(', ')}</p>
        </div>
      `).join('');
    }

    async function refreshUI() {
      const counters = await loadCounters();
      const history = await loadHistory();

      const entries = Object.entries(counters).sort((a, b) => b[1] - a[1]);
      const total = entries.reduce((sum, [, count]) => sum + count, 0);

      document.getElementById('metaText').textContent = `Total attempts this session: ${total}`;
      document.getElementById('totalText').textContent = `Total: ${total}`;
      document.getElementById('lastUpdated').textContent = `Updated: ${new Date().toLocaleString()}`;

      renderTable(entries);
      renderHistory(history);
    }

    document.getElementById('closeTab').addEventListener('click', () => window.close());
    document.getElementById('exportCsv').addEventListener('click', async () => {
      const counters = await loadCounters();
      const csv = 'Site,Attempts\n' + Object.entries(counters).map(([site, count]) => `"${site}",${count}`).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'focus_attempts.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('clearCounts').addEventListener('click', async () => {
      await chrome.storage.local.set({ [STORAGE_KEY]: {} });
      refreshUI();
    });
    refreshUI();
  </script>
</body>
</html>